<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>WORK_ORDER_EM - Multi Menu</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: Arial; font-size: 12px; margin: 12px; }
        .tabs { display:flex; gap:8px; margin-bottom:12px; }
        .tab { padding:8px 14px; background:#e9f0ff; border-radius:6px; cursor:pointer; user-select:none; }
        .tab.active { background:#2f80ed; color:white; font-weight:600; }
        .panel { display:none; }
        .panel.active { display:block; }
        .filter-container { margin-bottom: 12px; padding: 10px; background-color: #f7f7f7; border-radius: 6px; }
        .filter-container label { margin-right: 8px; font-size: 13px; }
        table { border-collapse: collapse; width: 100%; margin-top: 8px; }
        th, td { border: 1px solid #ccc; padding: 6px; }
        th { background-color: #eee; cursor: pointer; user-select: none; position: relative; }
        th.sort-asc::after { content: " ▲"; font-size: 10px; color: #333; }
        th.sort-desc::after { content: " ▼"; font-size: 10px; color: #333; }
        tbody tr:nth-child(odd) { background: #fbfdff; }
        tbody tr:hover { background: #eef6ff; }
        .small { font-size:11px; color:#333; }
        .controls { margin-top:8px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
        .btn { padding:6px 10px; border-radius:4px; border:1px solid #ccc; background:white; cursor:pointer; }
    </style>
</head>
<body>
    <h2>WORK_ORDER_EM</h2>

    <div class="tabs">
        <div class="tab active" id="tab-work">Work Order</div>
        <div class="tab" id="tab-detail">Detail Part</div>
        <div class="tab" id="tab-ext">External Job</div>
    </div>

    <!-- PANEL: Work Order (Menu 1) -->
    <div class="panel active" id="panel-work">
        <div class="filter-container">
            <label>Room: <input type="text" id="w-filter-room" placeholder="filter Room"></label>
            <label>Order: <input type="text" id="w-filter-order" placeholder="filter Order"></label>
            <label>MAT: <input type="text" id="w-filter-mat" placeholder="filter MAT"></label>
            <label>Section: <input type="text" id="w-filter-section" placeholder="filter Section"></label>
            <label>CPH: <input type="text" id="w-filter-cph" placeholder="filter CPH"></label>
            <label>Status: <input type="text" id="w-filter-status" placeholder="filter Status"></label>
            <div class="controls">
                <input type="file" id="w-upload" accept=".xlsx" />
                <button class="btn" id="w-clear">Clear filters</button>
            </div>
        </div>
        <table id="w-table" class="small"></table>
    </div>

    <!-- PANEL: Detail Part (Menu 2) -->
    <div class="panel" id="panel-detail">
        <div class="filter-container">
            <label>Order: <input type="text" id="d-filter-order" placeholder="filter Order"></label>
            <label>Material Number: <input type="text" id="d-filter-matnum" placeholder="filter Material Number"></label>
            <label>Material Description: <input type="text" id="d-filter-matdesc" placeholder="filter Material Description"></label>
            <div class="controls">
                <input type="file" id="d-upload" accept=".xlsx" />
                <button class="btn" id="d-clear">Clear filters</button>
            </div>
        </div>
        <table id="d-table" class="small"></table>
    </div>

    <!-- PANEL: External Job (Menu 3) -->
    <div class="panel" id="panel-ext">
        <div class="filter-container">
            <label>Room: <input type="text" id="e-filter-room" placeholder="filter Room"></label>
            <label>Order: <input type="text" id="e-filter-order" placeholder="filter Order"></label>
            <label>Activity: <input type="text" id="e-filter-activity" placeholder="filter Activity"></label>
            <label>Description: <input type="text" id="e-filter-desc" placeholder="filter Description"></label>
            <div class="controls">
                <input type="file" id="e-upload" accept=".xlsx" />
                <button class="btn" id="e-clear">Clear filters</button>
            </div>
        </div>
        <table id="e-table" class="small"></table>
    </div>

    <script>
    // ----------------- Shared helpers -----------------
    function formatDateFromSerialOrDate(v) {
        if (v === null || v === undefined || v === '') return "";
        const options = { day: '2-digit', month: 'short', year: 'numeric' };
        if (v instanceof Date) return v.toLocaleDateString('en-US', options).replace(/ /g, '-');
        if (typeof v === 'number') {
            const date = new Date(Math.round((v - 25569) * 86400 * 1000));
            return date.toLocaleDateString('en-US', options).replace(/ /g, '-');
        }
        const parsed = Date.parse(String(v));
        if (!isNaN(parsed)) return new Date(parsed).toLocaleDateString('en-US', options).replace(/ /g, '-');
        return String(v);
    }

    function formatCurrency(value) {
        if (value === null || value === undefined || value === '') return "";
        const num = Number(String(value).replace(/[^0-9.-]/g, ''));
        return !isNaN(num) ? ("$" + Math.round(num).toLocaleString()) : String(value);
    }

    function applyStyleToTd(td, colName, valText) {
        if (!td) return;
        const col = String(colName || '').toLowerCase();
        const val = (valText === null || valText === undefined) ? '' : String(valText).trim();
        if (["order","created on","planning","target date","end date","cost","include","exclude"].includes(col)) td.style.textAlign = "right";
        else if (["user status","mat"].includes(col)) td.style.textAlign = "center";
        else td.style.textAlign = "left";

        if (col === "status part") {
            if (val === "Complete") { td.style.backgroundColor = "green"; td.style.color = "white"; }
            else if (val === "Not Complete") { td.style.backgroundColor = "red"; td.style.color = "white"; }
        } else if (col === "aging") {
            const aging = parseInt(val);
            if (!isNaN(aging)) { td.style.backgroundColor = (aging <= 30) ? "green" : "red"; td.style.color = "white"; }
        } else if (col === "status amt") {
            if (val === "O") { td.style.backgroundColor = "lightgray"; td.style.color = "black"; }
            else if (val === "YTS") { td.style.backgroundColor = "green"; td.style.color = "white"; }
            else if (val === "IP") { td.style.backgroundColor = "orange"; td.style.color = "red"; }
            else if (val === "C") { td.style.backgroundColor = "black"; td.style.color = "white"; }
        }
    }

    function parseValueForSort(text) {
        const s = (text === null || text === undefined) ? '' : String(text).trim();
        if (s === '') return '';
        const num = Number(s.replace(/[^0-9.\-]/g, ''));
        if (!isNaN(num) && /[0-9]/.test(s)) return num;
        const parsed = Date.parse(s);
        if (!isNaN(parsed)) return parsed;
        return s.toLowerCase();
    }

    function clearSortIndicators(tableEl) {
        if (!tableEl) return;
        tableEl.querySelectorAll('th').forEach(th => {
            th.classList.remove('sort-asc','sort-desc');
            delete th.dataset.sorted;
        });
    }

    function debounce(fn, wait) {
        let t;
        return function(...args) {
            clearTimeout(t);
            t = setTimeout(() => fn.apply(this, args), wait);
        };
    }

    // ----------------- Tab switching -----------------
    const tabWork = document.getElementById('tab-work');
    const tabDetail = document.getElementById('tab-detail');
    const tabExt = document.getElementById('tab-ext');
    const panelWork = document.getElementById('panel-work');
    const panelDetail = document.getElementById('panel-detail');
    const panelExt = document.getElementById('panel-ext');

    tabWork.addEventListener('click', () => {
        tabWork.classList.add('active'); tabDetail.classList.remove('active'); tabExt.classList.remove('active');
        panelWork.classList.add('active'); panelDetail.classList.remove('active'); panelExt.classList.remove('active');
    });
    tabDetail.addEventListener('click', () => {
        tabDetail.classList.add('active'); tabWork.classList.remove('active'); tabExt.classList.remove('active');
        panelDetail.classList.add('active'); panelWork.classList.remove('active'); panelExt.classList.remove('active');
    });
    tabExt.addEventListener('click', () => {
        tabExt.classList.add('active'); tabWork.classList.remove('active'); tabDetail.classList.remove('active');
        panelExt.classList.add('active'); panelWork.classList.remove('active'); panelDetail.classList.remove('active');
    });

    // ----------------- Generic Table Builder -----------------
    function buildTableFromJson(tableEl, headers, rows) {
        while (tableEl.firstChild) tableEl.removeChild(tableEl.firstChild);
        const thead = document.createElement('thead');
        const tr = document.createElement('tr');
        headers.forEach((h, idx) => {
            const th = document.createElement('th');
            th.textContent = h;
            th.dataset.colIndex = idx;
            th.addEventListener('click', () => sortTableByIndex(tableEl, idx, th));
            tr.appendChild(th);
        });
        thead.appendChild(tr);
        tableEl.appendChild(thead);

        const tbody = document.createElement('tbody');
        const frag = document.createDocumentFragment();
        rows.forEach(rowArr => {
            const row = document.createElement('tr');
            for (let i = 0; i < headers.length; i++) {
                const colName = headers[i] || '';
                let rawVal = (rowArr && rowArr[i] !== undefined && rowArr[i] !== null) ? rowArr[i] : '';
                let cellText = '';
                const lc = colName.toLowerCase();
                if (["created on","planning","target date","end date"].includes(lc)) cellText = formatDateFromSerialOrDate(rawVal);
                else if (["cost","include","exclude"].includes(lc)) cellText = formatCurrency(rawVal);
                else cellText = rawVal instanceof Date ? formatDateFromSerialOrDate(rawVal) : String(rawVal);
                const td = document.createElement('td');
                td.textContent = cellText;
                applyStyleToTd(td, colName, cellText);
                row.appendChild(td);
            }
            frag.appendChild(row);
        });
        tbody.appendChild(frag);
        tableEl.appendChild(tbody);
    }

    function sortTableByIndex(tableEl, colIndex, thElement) {
        if (!tableEl || !tableEl.tBodies[0]) return;
        const tbody = tableEl.tBodies[0];
        const asc = thElement.dataset.sorted !== 'asc';
        clearSortIndicators(tableEl);
        thElement.dataset.sorted = asc ? 'asc' : 'desc';
        thElement.classList.add(asc ? 'sort-asc' : 'sort-desc');
        const rows = Array.from(tbody.rows);
        rows.sort((a,b)=>{
            const va = parseValueForSort(a.cells[colIndex]?.textContent||'');
            const vb = parseValueForSort(b.cells[colIndex]?.textContent||'');
            if(typeof va==='number' && typeof vb==='number') return asc?va-vb:vb-va;
            if(typeof va==='number') return asc?-1:1;
            if(typeof vb==='number') return asc?1:-1;
            return asc?String(va).localeCompare(String(vb)):String(vb).localeCompare(String(va));
        });
        rows.forEach(r=>tbody.appendChild(r));
    }

    // ----------------- Work Order (Menu 1) -----------------
    let wHeaders = [];
    const wTable = document.getElementById('w-table');
    document.getElementById('w-upload').addEventListener('change', function(e){
        const f=e.target.files[0]; if(!f) return;
        const reader = new FileReader();
        reader.onload=function(ev){
            const data=new Uint8Array(ev.target.result);
            const wb=XLSX.read(data,{type:'array'});
            const sheet=wb.Sheets[wb.SheetNames[0]];
            const json=XLSX.utils.sheet_to_json(sheet,{header:1,raw:true});
            if(!json||json.length===0){alert('No data');return;}
            wHeaders=json[0].map(h=>h===null||h===undefined?'':String(h).trim());
            const rows=json.slice(1);
            buildTableFromJson(wTable,wHeaders,rows);
            applyWorkFilters();
        };
        reader.readAsArrayBuffer(f);
    });

    function getIndex(headers, keyword){
        keyword=(keyword||'').toLowerCase();
        return headers.findIndex(h=>(h||'').toLowerCase().includes(keyword));
    }

    function applyWorkFilters(){
        const fRoom=(document.getElementById('w-filter-room').value||'').toLowerCase();
        const fOrder=(document.getElementById('w-filter-order').value||'').toLowerCase();
        const fMat=(document.getElementById('w-filter-mat').value||'').toLowerCase();
        const fSection=(document.getElementById('w-filter-section').value||'').toLowerCase();
        const fCph=(document.getElementById('w-filter-cph').value||'').toLowerCase();
        const fStatus=(document.getElementById('w-filter-status').value||'').toLowerCase();
        if(!wTable.tBodies[0]) return;
        const rows=Array.from(wTable.tBodies[0].rows);
        const idxRoom=getIndex(wHeaders,'room');
        const idxOrder=getIndex(wHeaders,'order');
        const idxMat=getIndex(wHeaders,'mat');
        const idxSection=getIndex(wHeaders,'section');
        const idxCph=getIndex(wHeaders,'cph');
        const idxStatus=getIndex(wHeaders,'status');
        rows.forEach(row=>{
            let show=true;
            if(fRoom && idxRoom>=0){const txt=row.cells[idxRoom]?.textContent.toLowerCase()||''; if(!txt.includes(fRoom)) show=false;}
            if(show && fOrder && idxOrder>=0){const txt=row.cells[idxOrder]?.textContent.toLowerCase()||''; if(!txt.includes(fOrder)) show=false;}
            if(show && fMat && idxMat>=0){const txt=row.cells[idxMat]?.textContent.toLowerCase()||''; if(!txt.includes(fMat)) show=false;}
            if(show && fSection && idxSection>=0){const txt=row.cells[idxSection]?.textContent.toLowerCase()||''; if(!txt.includes(fSection)) show=false;}
            if(show && fCph && idxCph>=0){const txt=row.cells[idxCph]?.textContent.toLowerCase()||''; if(!txt.includes(fCph)) show=false;}
            if(show && fStatus && idxStatus>=0){const txt=row.cells[idxStatus]?.textContent.toLowerCase()||''; if(!txt.includes(fStatus)) show=false;}
            row.style.display=show?'':'none';
        });
    }

    const debouncedApplyWorkFilters=debounce(applyWorkFilters,120);
    document.querySelectorAll("#panel-work .filter-container input[type=text]").forEach(inp=>inp.addEventListener('input',debouncedApplyWorkFilters));
    document.getElementById('w-clear').addEventListener('click',()=>{document.querySelectorAll("#panel-work .filter-container input[type=text]").forEach(i=>i.value='');applyWorkFilters();});

    // ----------------- Detail Part (Menu 2) -----------------
    let dHeaders=[]; const dTable=document.getElementById('d-table');
    document.getElementById('d-upload').addEventListener('change',function(e){
        const f=e.target.files[0]; if(!f) return;
        const reader=new FileReader();
        reader.onload=function(ev){
            const data=new Uint8Array(ev.target.result);
            const wb=XLSX.read(data,{type:'array'});
            const sheet=wb.Sheets[wb.SheetNames[0]];
            const json=XLSX.utils.sheet_to_json(sheet,{header:1,raw:true});
            if(!json||json.length===0){alert('No data');return;}
            dHeaders=json[0].map(h=>h===null||h===undefined?'':String(h).trim());
            const rows=json.slice(1);
            buildTableFromJson(dTable,dHeaders,rows);
            applyDetailFilters();
        };
        reader.readAsArrayBuffer(f);
    });

    function applyDetailFilters(){
        const fOrder=(document.getElementById('d-filter-order').value||'').toLowerCase();
        const fMatNum=(document.getElementById('d-filter-matnum').value||'').toLowerCase();
        const fMatDesc=(document.getElementById('d-filter-matdesc').value||'').toLowerCase();
        if(!dTable.tBodies[0]) return;
        const rows=Array.from(dTable.tBodies[0].rows);
        const idxOrder=getIndex(dHeaders,'order');
        const idxMatNum=getIndex(dHeaders,'material')!==-1?getIndex(dHeaders,'material'):getIndex(dHeaders,'material number');
        const idxMatDesc=getIndex(dHeaders,'description')!==-1?getIndex(dHeaders,'description'):getIndex(dHeaders,'material description');
        rows.forEach(row=>{
            let show=true;
            if(fOrder){if(idxOrder>=0){const txt=row.cells[idxOrder]?.textContent.toLowerCase()||''; if(!txt.includes(fOrder)) show=false;} else if(!row.textContent.toLowerCase().includes(fOrder)) show=false;}
            if(show && fMatNum){if(idxMatNum>=0){const txt=row.cells[idxMatNum]?.textContent.toLowerCase()||''; if(!txt.includes(fMatNum)) show=false;} else if(!row.textContent.toLowerCase().includes(fMatNum)) show=false;}
            if(show && fMatDesc){if(idxMatDesc>=0){const txt=row.cells[idxMatDesc]?.textContent.toLowerCase()||''; if(!txt.includes(fMatDesc)) show=false;} else if(!row.textContent.toLowerCase().includes(fMatDesc)) show=false;}
            row.style.display=show?'':'none';
        });
    }

    const debouncedApplyDetailFilters=debounce(applyDetailFilters,120);
    document.querySelectorAll("#panel-detail .filter-container input[type=text]").forEach(inp=>inp.addEventListener('input',debouncedApplyDetailFilters));
    document.getElementById('d-clear').addEventListener('click',()=>{document.querySelectorAll("#panel-detail .filter-container input[type=text]").forEach(i=>i.value='');applyDetailFilters();});

    // ----------------- External Job (Menu 3) -----------------
    let eHeaders=[]; const eTable=document.getElementById('e-table');
    const allowedCols=["Room","Manufacturer model number","Order Number","Maintenance activity type","Field displaying user status","Description","Aging WO","Net Price in PO USD","Cost Element","Service number","Service Short Text","Name","Purchase Requisition Number","Purchasing Document Number","Entry Sheet Number"];

    document.getElementById('e-upload').addEventListener('change',function(e){
        const f=e.target.files[0]; if(!f) return;
        const reader=new FileReader();
        reader.onload=function(ev){
            const data=new Uint8Array(ev.target.result);
            const wb=XLSX.read(data,{type:'array'});
            const sheet=wb.Sheets[wb.SheetNames[0]];
            const json=XLSX.utils.sheet_to_json(sheet,{header:1,raw:true});
            if(!json||json.length===0){alert('No data');return;}
            const rawHeaders=json[0].map(h=>h===null||h===undefined?'':String(h).trim());
            eHeaders=rawHeaders.filter(h=>allowedCols.includes(h));
            const rows=json.slice(1).map(r=>eHeaders.map(h=>{const idx=rawHeaders.indexOf(h); return idx>=0?r[idx]:"";}));
            buildTableFromJson(eTable,eHeaders,rows);
            applyExtFilters();
        };
        reader.readAsArrayBuffer(f);
    });

    function applyExtFilters(){
        const fRoom=(document.getElementById('e-filter-room').value||'').toLowerCase();
        const fOrder=(document.getElementById('e-filter-order').value||'').toLowerCase();
        const fAct=(document.getElementById('e-filter-activity').value||'').toLowerCase();
        const fDesc=(document.getElementById('e-filter-desc').value||'').toLowerCase();
        if(!eTable.tBodies[0]) return;
        const rows=Array.from(eTable.tBodies[0].rows);
        const idxRoom=eHeaders.indexOf("Room");
        const idxOrder=eHeaders.indexOf("Order Number");
        const idxAct=eHeaders.indexOf("Maintenance activity type");
        const idxDesc=eHeaders.indexOf("Description");
        rows.forEach(row=>{
            let show=true;
            if(fRoom && idxRoom>=0 && !(row.cells[idxRoom]?.textContent.toLowerCase()||'').includes(fRoom)) show=false;
            if(show && fOrder && idxOrder>=0 && !(row.cells[idxOrder]?.textContent.toLowerCase()||'').includes(fOrder)) show=false;
            if(show && fAct && idxAct>=0 && !(row.cells[idxAct]?.textContent.toLowerCase()||'').includes(fAct)) show=false;
            if(show && fDesc && idxDesc>=0 && !(row.cells[idxDesc]?.textContent.toLowerCase()||'').includes(fDesc)) show=false;
            row.style.display=show?'':'none';
        });
    }

    const debouncedApplyExtFilters=debounce(applyExtFilters,120);
    document.querySelectorAll("#panel-ext .filter-container input[type=text]").forEach(inp=>inp.addEventListener('input',debouncedApplyExtFilters));
    document.getElementById('e-clear').addEventListener('click',()=>{document.querySelectorAll("#panel-ext .filter-container input[type=text]").forEach(i=>i.value='');applyExtFilters();});
    </script>
</body>
</html>
