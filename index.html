<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Work_Order_EM — Full</title>

<!-- style -->
<style>
  :root{
    --blue:#2e86de; --peach:#ffe0cc; --ink:#111;
    --line:#e3e6ea;
  }
  body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#eaf3ff;color:var(--ink)}
  header{background:var(--blue);color:#fff;padding:14px;text-align:center}
  header h1{margin:0;font-size:20px}
  nav.tabs{display:flex;gap:6px;justify-content:center;padding:10px;background:#fff}
  .tablink{padding:8px 14px;border-radius:6px;border:1px solid #333;background:var(--peach);cursor:pointer;font-weight:700}
  .tablink.active{box-shadow:0 0 0 3px rgba(0,0,0,0.12)}
  main{padding:14px}
  .card{background:#fff;border:1px solid var(--line);border-radius:6px;padding:12px;margin-bottom:12px}
  .file-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px}
  .file-item{display:flex;flex-direction:column;gap:8px;border:1px solid #dfe7ef;padding:8px;border-radius:6px;background:#fbfeff}
  label.small{font-weight:700;font-size:13px}
  .actions{display:flex;gap:8px;align-items:center}
  button{padding:8px 12px;border-radius:6px;border:1px solid #333;background:#f6c8a5;cursor:pointer;font-weight:700}
  button.ghost{background:#fff}
  .status{font-size:13px;color:#222;margin-top:6px}
  .progress{height:10px;background:#eee;border-radius:6px;overflow:hidden}
  .progress > i{display:block;height:100%;width:0%;background:#2e86de;transition:width .2s}
  .table-wrap{overflow:auto;max-height:480px;border:1px solid var(--line);border-radius:6px;padding:6px;background:#fff}
  table{border-collapse:collapse;width:100%}
  th,td{border:1px solid #d9dde3;padding:6px 8px;font-size:12px}
  thead th{position:sticky;top:0;background:#ff8c00;color:#fff}
  .meta{font-size:12px;color:#555;margin:8px 0}
  .filter-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .filter-row input{padding:6px;border:1px solid #cfd7e0;border-radius:4px}
  .small-note{font-size:12px;color:#666}
  .spinner{display:inline-block;width:14px;height:14px;border:2px solid #ddd;border-top-color:#2e86de;border-radius:50%;animation:spin .8s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  footer{padding:10px;text-align:center;font-size:12px;color:#666}
  .danger{color:#c0392b;font-weight:700}
</style>
</head>
<body>

<header>
  <h1>Work_Order_EM</h1>
  <div class="small-note">Upload Excel → files saved to repo /data/. After upload page will fetch latest data from repo.</div>
</header>

<nav class="tabs">
  <button class="tablink active" data-tab="menu1">Upload File</button>
  <button class="tablink" data-tab="menu2">Monitoring Order</button>
  <button class="tablink" data-tab="menu3">Detail Part & Component</button>
  <button class="tablink" data-tab="menu4">External Job</button>
</nav>

<main>
  <!-- MENU 1 -->
  <section id="menu1" class="tabcontent" style="display:block">
    <div class="card">
      <h3>Menu 1 — Upload File (pilih lalu klik Upload)</h3>
      <div class="file-grid" id="fileGrid">
        <!-- each item generated by JS -->
      </div>
      <div style="margin-top:10px">
        <button id="btn-fetch-all" class="ghost">Fetch latest from repo (refresh)</button>
        <button id="btn-clear-state" class="ghost">Clear loaded data (local)</button>
      </div>
    </div>

    <div class="card">
      <h4>Preview / Last loaded</h4>
      <div id="preview-meta" class="meta"></div>
      <div id="preview-table" class="table-wrap"></div>
    </div>
  </section>

  <!-- MENU 2 -->
  <section id="menu2" class="tabcontent" style="display:none">
    <div class="card">
      <h3>Menu 2 — Monitoring Order</h3>
      <div class="filter-row">
        <label class="small">Room <input id="fl-room" /></label>
        <label class="small">Order <input id="fl-order" /></label>
        <label class="small">MAT <input id="fl-mat" /></label>
        <label class="small">CPH <input id="fl-cph" /></label>
        <label class="small">Section <input id="fl-section" /></label>
        <label class="small">Status Part <input id="fl-statuspart" /></label>
        <div style="display:flex;gap:8px">
          <button id="btn-apply2">Apply</button>
          <button id="btn-reset2" class="ghost">Reset</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div id="table-menu2" class="table-wrap"></div>
    </div>
  </section>

  <!-- MENU 3 -->
  <section id="menu3" class="tabcontent" style="display:none">
    <div class="card">
      <h3>Menu 3 — Detail Part & Component (from DET)</h3>
      <div class="filter-row">
        <label class="small">Order <input id="m3-order" /></label>
        <label class="small">Material Number <input id="m3-matno" /></label>
        <label class="small">Material Description <input id="m3-matdesc" /></label>
        <div style="display:flex;gap:8px"><button id="btn-apply3">Apply</button><button id="btn-reset3" class="ghost">Reset</button></div>
      </div>
    </div>
    <div class="card"><div id="table-menu3" class="table-wrap"></div></div>
  </section>

  <!-- MENU 4 -->
  <section id="menu4" class="tabcontent" style="display:none">
    <div class="card">
      <h3>Menu 4 — External Job (from Rxternal Job)</h3>
      <div class="filter-row">
        <label class="small">Room <input id="m4-room" /></label>
        <label class="small">Order Number <input id="m4-order" /></label>
        <label class="small">PO Number <input id="m4-po" /></label>
        <div style="display:flex;gap:8px"><button id="btn-apply4">Apply</button><button id="btn-reset4" class="ghost">Reset</button></div>
      </div>
    </div>
    <div class="card"><div id="table-menu4" class="table-wrap"></div></div>
  </section>
</main>

<footer>Work_Order_EM — local demo with GitHub repo storage (data/). Be careful with PAT exposure.</footer>

<!-- SheetJS -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<!-- App JS -->
<script>
/* =========================
   CONFIG — EDIT THIS PART
   ========================= */
const GITHUB_USERNAME = "endboedy";       // <-- ganti kalau perlu
const REPO_NAME = "Work_Order_EM";        // <-- ganti kalau perlu
const REPO_BRANCH = "main";               // <-- biasanya main
let GITHUB_TOKEN = "";                    // <-- PASTE token di sini (ghp_xxx...), atau set via prompt below

// Allowed filenames (as kamu upload)
const FILES = [
  "IW39.xlsx",
  "SUM57.xlsx",
  "DET.xlsx",
  "Rxternal Job.xlsx",   // sesuai nama yang kamu sebut
  "Planning.xlsx",
  "Equipt Adm.xlsx",
  "Data1.xlsx",
  "Data2.xlsx"
];

const RAW_BASE = https://raw.githubusercontent.com/${GITHUB_USERNAME}/${REPO_NAME}/${REPO_BRANCH}/data/;

/* If you prefer to paste token at runtime, uncomment next line */
// GITHUB_TOKEN = prompt("Paste your GitHub Personal Access Token (scope repo/public_repo):");

/* =========================
   END CONFIG
   ========================= */

const state = {}; // store parsed workbook info per filename

/* ---- Helpers ---- */
const q = sel => document.querySelector(sel);
const el = (t, a={}) => Object.assign(document.createElement(t), a);
const norm = v => (v==null ? "" : String(v).trim());
const toNum = v => { const n = Number(String(v||'').replace(/[^0-9.-]/g,'')); return isNaN(n)?0:n; };

/* ---- UI: tabs ---- */
document.querySelectorAll('.tablink').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tablink').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.tabcontent').forEach(s=>s.style.display='none');
    btn.classList.add('active');
    document.getElementById(btn.dataset.tab).style.display='block';
  });
});

/* ---- Build file upload UI ---- */
const fileGrid = q('#fileGrid');
FILES.forEach(fname=>{
  const wrap = el('div',{className:'file-item'});
  const title = el('div',{innerHTML:<span class="small-note">${fname}</span>});
  const input = el('input'); input.type='file'; input.accept='.xlsx,.xls'; input.dataset.fname=fname;
  const btn = el('button',{textContent:'Upload', title:'Upload this file to repo', onclick:()=>uploadSelectedFile(input)});
  const progress = el('div',{className:'progress', innerHTML:'<i></i>'});
  const status = el('div',{className:'status', textContent:'No file chosen'});
  input.addEventListener('change', ()=> {
    status.textContent = input.files[0] ? Selected: ${input.files[0].name} : 'No file chosen';
  });
  wrap.appendChild(title); wrap.appendChild(input);
  const actions = el('div',{className:'actions'});
  actions.appendChild(btn); actions.appendChild(progress); wrap.appendChild(actions);
  wrap.appendChild(status);
  fileGrid.appendChild(wrap);
});

/* ---- Upload logic ----
   We will:
   - read file as DataURL (read progress used to show progress)
   - extract base64 content
   - PUT to GitHub API /repos/:owner/:repo/contents/data/:path
*/
async function uploadSelectedFile(inputEl){
  const fname = inputEl.dataset.fname;
  const file = inputEl.files[0];
  if(!file){ alert('Pilih file dulu untuk: ' + fname); return; }
  if(!GITHUB_TOKEN){ GITHUB_TOKEN = prompt('Paste your GitHub Personal Access Token (scope repo/public_repo):'); if(!GITHUB_TOKEN) return; }

  // find UI elements: progress & status
  const container = inputEl.closest('.file-item');
  const progressBar = container.querySelector('.progress > i');
  const statusEl = container.querySelector('.status');

  statusEl.textContent = 'Reading file...';
  progressBar.style.width = '0%';

  const reader = new FileReader();
  reader.onprogress = (ev) => {
    if(ev.lengthComputable){
      const p = Math.round((ev.loaded/ev.total)*60); // up to 60% from reading
      progressBar.style.width = p + '%';
    }
  };

  reader.onload = async () => {
    try {
      progressBar.style.width = '65%';
      statusEl.innerHTML = '<span class="small-note">Preparing upload...</span> <span class="spinner"></span>';

      // DataURL => base64
      const dataUrl = reader.result;
      const base64 = dataUrl.split(',')[1];

      // We need to check if file already exists to include sha for update.
      const apiPath = /repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/data/${encodeURIComponent(fname)};
      const apiUrl = 'https://api.github.com' + apiPath;

      // check existing file to get sha
      let sha = null;
      try {
        const headResp = await fetch(apiUrl + ?ref=${REPO_BRANCH}, {
          method: 'GET',
          headers: {'Authorization': 'token ' + GITHUB_TOKEN}
        });
        if(headResp.ok){
          const j = await headResp.json();
          sha = j.sha;
        }
      } catch(e){
        // ignore - not existing likely
      }

      // build body
      const body = {
        message: Upload ${fname},
        content: base64,
        branch: REPO_BRANCH
      };
      if(sha) body.sha = sha;

      // perform upload (PUT)
      const putResp = await fetch(apiUrl, {
        method: 'PUT',
        headers: {
          'Authorization': 'token ' + GITHUB_TOKEN,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(body)
      });

      if(putResp.ok){
        progressBar.style.width = '100%';
        statusEl.innerHTML = ✅ Upload sukses: ${fname};
        // auto fetch and parse updated file
        await fetchAndParseFile(fname);
        q('#preview-meta').textContent = ${fname} (uploaded & loaded);
      } else {
        const err = await putResp.json();
        statusEl.innerHTML = ❌ Upload gagal: ${err.message || 'unknown'};
        progressBar.style.width = '0%';
      }
    } catch(e){
      statusEl.innerHTML = ⚠ Error: ${e.message};
      progressBar.style.width = '0%';
    }
  };

  reader.onerror = () => {
    container.querySelector('.status').textContent = 'Error reading file';
  };

  reader.readAsDataURL(file);
}

/* ---- Fetch raw Excel from repo and parse ---- */
async function fetchAndParseFile(fname){
  const url = RAW_BASE + encodeURIComponent(fname);
  try {
    // try fetch as arrayBuffer (CORS should allow raw.githubusercontent)
    const resp = await fetch(url);
    if(!resp.ok) throw new Error('File not found: ' + fname);
    const ab = await resp.arrayBuffer();
    const wb = XLSX.read(ab, {type:'array'});
    const sheetName = wb.SheetNames[0];
    const rows = XLSX.utils.sheet_to_json(wb.Sheets[sheetName], {defval:''});
    state[fname] = {sheetName, rows};
    console.log('Loaded', fname, rows.length);
    return state[fname];
  } catch(err){
    console.warn('Fetch/parse failed for', fname, err.message);
    state[fname] = null;
    return null;
  }
}

/* ---- Fetch all files (if present) ---- */
async function fetchAllFiles(){
  q('#preview-meta').textContent = 'Fetching files from repo...';
  q('#preview-table').innerHTML = '';
  for(const f of FILES){
    await fetchAndParseFile(f);
  }
  q('#preview-meta').textContent = 'Fetch selesai.';
  // auto render preview of IW39 if present
  if(state["IW39.xlsx"]) renderPreview(state["IW39.xlsx"].rows.slice(0,200));
  else q('#preview-table').innerHTML = '<div class="meta">IW39.xlsx not found in repo/data/</div>';
}

/* ---- Render preview helper ---- */
function renderPreview(rows){
  const container = q('#preview-table');
  container.innerHTML = '';
  if(!rows || rows.length===0){ container.innerHTML = '<div class="meta">No rows</div>'; return; }
  const tbl = el('table');
  const thead = el('thead'); const trh = el('tr');
  const cols = Object.keys(rows[0]);
  cols.forEach(c=> trh.appendChild(el('th',{textContent:c})));
  thead.appendChild(trh); tbl.appendChild(thead);
  const tbody = el('tbody');
  rows.forEach(r=>{
    const tr = el('tr');
    cols.forEach(c=> tr.appendChild(el('td',{textContent:r[c]})));
    tbody.appendChild(tr);
  });
  tbl.appendChild(tbody); container.appendChild(tbl);
}

/* ---- Build Menu 2 rows: apply lookups and include/exclude ---- */
function indexBy(rows, key){
  if(!rows) return {};
  const out = {};
  rows.forEach(r=>{
    const k = norm(r[key]);
    if(k) out[k] = r;
  });
  return out;
}

function buildMenu2Rows(){
  const iwRows = state["IW39.xlsx"]?.rows || [];
  const sumByOrder = indexBy(state["SUM57.xlsx"]?.rows, 'Order');
  const data1ByRoom = indexBy(state["Data1.xlsx"]?.rows, 'Room');
  const data2ByMAT = indexBy(state["Data2.xlsx"]?.rows, 'MAT');
  const planningByOrder = indexBy(state["Planning.xlsx"]?.rows, 'Order');
  const equipByRoom = indexBy(state["Equipt Adm.xlsx"]?.rows, 'Room');

  const out = iwRows.map(r=>{
    const order = norm(r['Order'] || r['Order Number'] || r['WO']);
    const room = norm(r['Room']);
    const desc = norm(r['Description']||r['Desc']||'');
    const orderType = norm(r['Order Type']||r['Type']||'');
    const plan = toNum(r['Total sum (plan)']||r['Plan']||r['Total Plan']);
    const actual = toNum(r['Total sum (actual)']||r['Actual']||r['Total Actual']);
    // CPH logic:
    let cph = '';
    if(desc.substr(0,2).toUpperCase()==='JR') cph = 'External Job';
    else {
      // lookup Data2 by MAT
      const matKey = norm(r['MAT']||r['Material']||'');
      const d2 = data2ByMAT[matKey] || {};
      cph = d2['CPH'] || d2['Value'] || '';
    }
    // section lookup
    const sec = (data1ByRoom[room] && (data1ByRoom[room]['Section'] || data1ByRoom[room]['Value'])) || '';

    // sum lookup
    const sumRow = sumByOrder[order] || {};
    const statusPart = sumRow['Status Part'] || sumRow['Status'] || '';
    const aging = sumRow['Aging'] || sumRow['Aging WO'] || '';

    // planning lookup
    const planRow = planningByOrder[order] || {};
    const eventStart = planRow['Event Start'] || planRow['Start Date'] || planRow['Plan Start'] || '';
    const statusAMT = planRow['Status AMT'] || planRow['Status'] || '';
    const targetDate = planRow['Target Date'] || planRow['Target'] || '';

    // equip lookup
    const eqRow = equipByRoom[room] || {};
    const endDate = eqRow['End Date'] || eqRow['Finish Date'] || '';

    const include = ((plan - actual)/16500) || 0;
    const includeDisplay = (include===0)? '' : Number.isFinite(include) ? include.toFixed(2) : '';

    const exclude = (orderType.toUpperCase()==='PM38') ? '' : includeDisplay;

    return {
      'Room': room,
      'Order Type': orderType,
      'Order': order,
      'Description': desc,
      'Created On': r['Created On'] || r['CreatedOn'] || '',
      'User Status': r['User Status']||r['Status']||'',
      'MAT': r['MAT']||'',
      'CPH': cph,
      'Section': sec,
      'Status Part': statusPart,
      'Aging': aging,
      'Include': includeDisplay,
      'Exclude': exclude,
      'Event Start': eventStart,
      'Status AMT': statusAMT,
      'Target Date': targetDate,
      'End Date': endDate
    };
  });

  return out;
}

/* ---- mount generic table with specified columns order ---- */
function mountTable(containerSelector, rows, orderCols){
  const cont = q(containerSelector);
  cont.innerHTML = '';
  if(!rows || rows.length===0){ cont.innerHTML = '<div class="meta">No data (make sure the corresponding Excel is uploaded in repo/data/).</div>'; return; }
  const tbl = el('table');
  const thead = el('thead'); const trh = el('tr');
  orderCols.forEach(c=> trh.appendChild(el('th',{textContent:c})));
  thead.appendChild(trh); tbl.appendChild(thead);
  const tbody = el('tbody');
  rows.forEach(r=>{
    const tr = el('tr');
    orderCols.forEach(c=> tr.appendChild(el('td',{textContent: r[c] ?? ''})));
    tbody.appendChild(tr);
  });
  tbl.appendChild(tbody); cont.appendChild(tbl);
}

/* ---- Menu 2 rendering ---- */
function renderMenu2(){
  const rows = buildMenu2Rows();
  // filters:
  const fl = {
    room: norm(q('#fl-room').value).toLowerCase(),
    order: norm(q('#fl-order').value).toLowerCase(),
    mat: norm(q('#fl-mat').value).toLowerCase(),
    cph: norm(q('#fl-cph').value).toLowerCase(),
    section: norm(q('#fl-section').value).toLowerCase(),
    statuspart: norm(q('#fl-statuspart').value).toLowerCase()
  };
  const filtered = rows.filter(r=>{
    return (!fl.room || String(r['Room']).toLowerCase().includes(fl.room))
        && (!fl.order || String(r['Order']).toLowerCase().includes(fl.order))
        && (!fl.mat || String(r['MAT']).toLowerCase().includes(fl.mat))
        && (!fl.cph || String(r['CPH']).toLowerCase().includes(fl.cph))
        && (!fl.section || String(r['Section']).toLowerCase().includes(fl.section))
        && (!fl.statuspart || String(r['Status Part']).toLowerCase().includes(fl.statuspart));
  });

  mountTable('#table-menu2', filtered, [
    'Room','Order Type','Order','Description','Created On','User Status','MAT',
    'CPH','Section','Status Part','Aging','Include','Exclude','Event Start',
    'Status AMT','Target Date','End Date'
  ]);
}
q('#btn-apply2').addEventListener('click', renderMenu2);
q('#btn-reset2').addEventListener('click', ()=>{
  ['#fl-room','#fl-order','#fl-mat','#fl-cph','#fl-section','#fl-statuspart'].forEach(id=>q(id).value='');
  renderMenu2();
});

/* ---- Menu 3 (DET) ---- */
function renderMenu3(){
  const rows = state["DET.xlsx"]?.rows || [];
  const flOrder = norm(q('#m3-order').value).toLowerCase();
  const flMatNo = norm(q('#m3-matno').value).toLowerCase();
  const flMatDesc = norm(q('#m3-matdesc').value).toLowerCase();

  const mapped = rows.map(r=>({
    'Room': r['Room']||'',
    'Order': r['Order']||r['WO']||'',
    'Description': r['Description']||'',
    'WO User Status': r['WO User Status']||r['User Status']||'',
    'Material Number': r['Material Number']||r['Material']||'',
    'Material Description': r['Material Description']||r['Material Description']||r['Mat Desc']||'',
    'Requirement Quantity': r['Requirement Quantity']||r['Req Qty']||'',
    'Total Stock': r['Total Stock']||'',
    'Quantity withdrawn': r['Quantity withdrawn']||'',
    'Outstanding Withdrawn qty': r['Outstanding Withdrawn qty']||'',
    'Aging': r['Aging']||r['Aging WO']||''
  }));

  const filtered = mapped.filter(r=>{
    return (!flOrder || String(r['Order']).toLowerCase().includes(flOrder))
        && (!flMatNo || String(r['Material Number']).toLowerCase().includes(flMatNo))
        && (!flMatDesc || String(r['Material Description']).toLowerCase().includes(flMatDesc));
  });

  mountTable('#table-menu3', filtered, [
    'Room','Order','Description','WO User Status','Material Number',
    'Material Description','Requirement Quantity','Total Stock',
    'Quantity withdrawn','Outstanding Withdrawn qty','Aging'
  ]);
}
q('#btn-apply3').addEventListener('click', renderMenu3);
q('#btn-reset3').addEventListener('click', ()=>{
  ['#m3-order','#m3-matno','#m3-matdesc'].forEach(id=>q(id).value='');
  renderMenu3();
});

/* ---- Menu 4 (Rxternal Job) ---- */
function renderMenu4(){
  const rows = state["Rxternal Job.xlsx"]?.rows || state["External Job.xlsx"]?.rows || [];
  const flRoom = norm(q('#m4-room').value).toLowerCase();
  const flOrder = norm(q('#m4-order').value).toLowerCase();
  const flPO = norm(q('#m4-po').value).toLowerCase();

  const mapped = rows.map(r=>({
    'Room': r['Room']||'',
    'Manufacturer model number': r['Manufacturer model number']||r['Model']||'',
    'Order Number': r['Order Number']||r['Order']||'',
    'Maintenance activity type': r['Maintenance activity type']||'',
    'Field displaying user status': r['Field displaying user status']||r['User Status']||'',
    'Description': r['Description']||'',
    'Aging WO': r['Aging WO']||r['Aging']||'',
    'Net Price in PO USD': r['Net Price in PO USD']||r['Net Price in USD']||'',
    'Cost Element': r['Cost Element']||'',
    'Service number': r['Service number']||'',
    'Service Short Text': r['Service Short Text']||r['Short Text']||'',
    'Name': r['Name']||'',
    'Purchase Requisition Number': r['Purchase Requisition Number']||'',
    'Purchasing Document Number': r['Purchasing Document Number']||r['PO']||r['Purchasing Document Number']||'',
    'Entry Sheet Number': r['Entry Sheet Number']||''
  }));

  const filtered = mapped.filter(r=>{
    return (!flRoom || String(r['Room']).toLowerCase().includes(flRoom))
        && (!flOrder || String(r['Order Number']).toLowerCase().includes(flOrder))
        && (!flPO || String(r['Purchasing Document Number']).toLowerCase().includes(flPO));
  });

  mountTable('#table-menu4', filtered, [
    'Room','Manufacturer model number','Order Number','Maintenance activity type',
    'Field displaying user status','Description','Aging WO','Net Price in PO USD',
    'Cost Element','Service number','Service Short Text','Name',
    'Purchase Requisition Number','Purchasing Document Number','Entry Sheet Number'
  ]);
}
q('#btn-apply4').addEventListener('click', renderMenu4);
q('#btn-reset4').addEventListener('click', ()=>{
  ['#m4-room','#m4-order','#m4-po'].forEach(id=>q(id).value='');
  renderMenu4();
});

/* ---- Buttons: fetch all & clear state ---- */
q('#btn-fetch-all').addEventListener('click', async ()=>{
  await fetchAllFiles();
  alert('Fetch selesai. Cek preview dan menu yang relevan.');
});
q('#btn-clear-state').addEventListener('click', ()=>{
  Object.keys(state).forEach(k=>state[k]=null);
  q('#preview-meta').textContent='Cleared local state.';
  q('#preview-table').innerHTML='';
});

/* ---- On load: fetch files automatically (best-effort) ---- */
(async ()=>{
  try{
    await fetchAllFiles();
  }catch(e){
    console.warn('Auto fetch failed', e);
  }
})();

/* ---- auto-render menu tables when switching to tab (so user sees latest) ---- */
document.querySelector('[data-tab="menu2"]').addEventListener('click', renderMenu2);
document.querySelector('[data-tab="menu3"]').addEventListener('click', renderMenu3);
document.querySelector('[data-tab="menu4"]').addEventListener('click', renderMenu4);

/* ---- end of script ---- */
</script>

</body>
</html>
