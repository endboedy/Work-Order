<!DOCTYPE html>
<html>
<head>
    <title>WORK_ORDER_EM</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: Arial; font-size: 11px; }
        .filter-container { margin-bottom: 20px; padding: 10px; background-color: #f0f0f0; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ccc; padding: 4px; cursor: pointer; }
        th { background-color: #eee; }
    </style>
</head>
<body>
    <h2>WORK_ORDER_EM</h2>
    <div class="filter-container">
        <label>Room: <input type="text" id="filter-room"></label>
        <label>Order: <input type="text" id="filter-order"></label>
        <label>MAT: <input type="text" id="filter-mat"></label>
        <label>Section: <input type="text" id="filter-section"></label>
        <label>CPH: <input type="text" id="filter-cph"></label>
        <label>Status: <input type="text" id="filter-status"></label>
        <br><br>
        <input type="file" id="upload" accept=".xlsx" />
    </div>
    <table id="wo-table"></table>

    <script>
        function formatDate(excelDate) {
            if (!excelDate) return "";
            const date = new Date(Math.round((excelDate - 25569) * 86400 * 1000));
            const options = { day: '2-digit', month: 'short', year: 'numeric' };
            return date.toLocaleDateString('en-US', options).replace(/ /g, '-');
        }

        function formatCurrency(value) {
            if (!value) return "";
            return "$" + parseInt(value).toLocaleString();
        }

        function sortTable(header) {
            const table = header.closest("table");
            const ths = Array.from(table.querySelectorAll("th"));
            const index = ths.indexOf(header);
            const rows = Array.from(table.querySelectorAll("tbody tr"));
            const asc = !header.asc;
            header.asc = asc;

            rows.sort((a, b) => {
                const cellA = a.cells[index].innerText;
                const cellB = b.cells[index].innerText;
                return asc ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
            });

            rows.forEach(row => table.querySelector("tbody").appendChild(row));
        }

        function applyStyle(col, val) {
            let style = "";
            let align = "left";
            if (["Order", "Created On", "Planning", "Target Date", "End Date", "Cost", "Include", "Exclude"].includes(col)) {
                align = "right";
            } else if (["User Status", "MAT"].includes(col)) {
                align = "center";
            }

            if (col === "Status Part") {
                if (val === "Complete") style = "background-color:green;color:white";
                else if (val === "Not Complete") style = "background-color:red;color:white";
            } else if (col === "Aging") {
                const aging = parseInt(val);
                if (!isNaN(aging)) {
                    if (aging <= 30) style = "background-color:green;color:white";
                    else style = "background-color:red;color:white";
                }
            } else if (col === "Status AMT") {
                if (val === "") style = "background-color:white;color:black";
                else if (val === "O") style = "background-color:lightgray;color:black";
                else if (val === "YTS") style = "background-color:green;color:white";
                else if (val === "IP") style = "background-color:orange;color:red";
                else if (val === "C") style = "background-color:black;color:white";
            }

            return style="text-align:${align};${style}";
        }

        function filterTable() {
            const room = document.getElementById("filter-room").value.toLowerCase();
            const order = document.getElementById("filter-order").value.toLowerCase();
            const mat = document.getElementById("filter-mat").value.toLowerCase();
            const section = document.getElementById("filter-section").value.toLowerCase();
            const cph = document.getElementById("filter-cph").value.toLowerCase();
            const status = document.getElementById("filter-status").value.toLowerCase();

            const rows = document.querySelectorAll("#wo-table tbody tr");

            rows.forEach(row => {
                const cells = Array.from(row.cells).map(td => td.innerText.toLowerCase());
                const show =
                    (!room || cells.some(c => c.includes(room))) &&
                    (!order || cells.some(c => c.includes(order))) &&
                    (!mat || cells.some(c => c.includes(mat))) &&
                    (!section || cells.some(c => c.includes(section))) &&
                    (!cph || cells.some(c => c.includes(cph))) &&
                    (!status || cells.some(c => c.includes(status)));
                row.style.display = show ? "" : "none";
            });
        }

        document.querySelectorAll(".filter-container input[type=text]").forEach(inp => {
            inp.addEventListener("input", filterTable);
        });

        document.getElementById('upload').addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(sheet, {header:1});
                const header = json[0];
                const rows = json.slice(1);

                let table = "<thead><tr>" + 
    header.map(h => <th onclick="sortTable(this)">${h}</th>).join("") + 
    "</tr></thead><tbody>";

rows.forEach(row => {
    table += "<tr>";
    header.forEach((col, i) => {
        let val = row[i] || "";
        if (["Created On", "Planning", "Target Date", "End Date"].includes(col)) {
            val = formatDate(val);
        } else if (["Cost", "Include", "Exclude"].includes(col)) {
            val = formatCurrency(val);
        }
        const style = applyStyle(col, val);
        table += <td ${style}>${val}</td>;
    });
    table += "</tr>";
});
table += "</tbody>";

                document.getElementById("wo-table").innerHTML = table;
            };
            reader.readAsArrayBuffer(e.target.files[0]);
        });
    </script>
</body>
</html>
