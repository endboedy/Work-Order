<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>WORK_ORDER_EM - Multi Menu</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
body { font-family: Arial; font-size: 12px; margin: 12px; }
.tabs { display:flex; gap:8px; margin-bottom:12px; }
.tab { padding:8px 14px; background:#e9f0ff; border-radius:6px; cursor:pointer; user-select:none; }
.tab.active { background:#2f80ed; color:white; font-weight:600; }
.panel { display:none; }
.panel.active { display:block; }
.filter-container { margin-bottom: 12px; padding: 10px; background-color: #f7f7f7; border-radius: 6px; }
.filter-container label { margin-right: 8px; font-size: 13px; }
table { border-collapse: collapse; width: 100%; margin-top: 8px; }
th, td { border: 1px solid #ccc; padding: 6px; }
th { background-color: #eee; cursor: pointer; user-select: none; position: relative; }
th.sort-asc::after { content: " ▲"; font-size: 10px; color: #333; }
th.sort-desc::after { content: " ▼"; font-size: 10px; color: #333; }
tbody tr:nth-child(odd) { background: #fbfdff; }
tbody tr:hover { background: #eef6ff; }
.small { font-size:11px; color:#333; }
.controls { margin-top:8px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
.btn { padding:6px 10px; border-radius:4px; border:1px solid #ccc; background:white; cursor:pointer; }
</style>
</head>
<body>
<h2>WORK_ORDER_EM</h2>

<div class="tabs">
  <div class="tab active" id="tab-work">Work Order</div>
  <div class="tab" id="tab-detail">Detail Part</div>
  <div class="tab" id="tab-ext">External Job</div>
  <div class="tab" id="tab-monthly">List WO Monthly</div>
  <div class="tab" id="tab-addmonthly">Add WO Monthly</div>
</div>

<!-- PANEL 1: Work Order -->
<div class="panel active" id="panel-work">
  <div class="filter-container">
    <label>Room: <input type="text" id="w-filter-room" placeholder="filter Room"></label>
    <label>Order: <input type="text" id="w-filter-order" placeholder="filter Order"></label>
    <label>MAT: <input type="text" id="w-filter-mat" placeholder="filter MAT"></label>
    <label>Section: <input type="text" id="w-filter-section" placeholder="filter Section"></label>
    <label>CPH: <input type="text" id="w-filter-cph" placeholder="filter CPH"></label>
    <label>Status: <input type="text" id="w-filter-status" placeholder="filter Status"></label>
    <div class="controls">
      <input type="file" id="w-upload" accept=".xlsx" />
      <button class="btn" id="w-clear">Clear filters</button>
    </div>
  </div>
  <table id="w-table" class="small"></table>
</div>

<!-- PANEL 2: Detail Part -->
<div class="panel" id="panel-detail">
  <div class="filter-container">
    <label>Order: <input type="text" id="d-filter-order" placeholder="filter Order"></label>
    <label>Material Number: <input type="text" id="d-filter-matnum" placeholder="filter Material Number"></label>
    <label>Material Description: <input type="text" id="d-filter-matdesc" placeholder="filter Material Description"></label>
    <div class="controls">
      <input type="file" id="d-upload" accept=".xlsx" />
      <button class="btn" id="d-clear">Clear filters</button>
    </div>
  </div>
  <table id="d-table" class="small"></table>
</div>

<!-- PANEL 3: External Job -->
<div class="panel" id="panel-ext">
  <div class="filter-container">
    <label>Room: <input type="text" id="e-filter-room" placeholder="filter Room"></label>
    <label>Order: <input type="text" id="e-filter-order" placeholder="filter Order"></label>
    <label>Activity: <input type="text" id="e-filter-activity" placeholder="filter Activity"></label>
    <label>Description: <input type="text" id="e-filter-desc" placeholder="filter Description"></label>
    <div class="controls">
      <input type="file" id="e-upload" accept=".xlsx" />
      <button class="btn" id="e-clear">Clear filters</button>
    </div>
  </div>
  <table id="e-table" class="small"></table>
</div>

<!-- PANEL 4: List WO Monthly -->
<div class="panel" id="panel-monthly">
  <div class="filter-container">
    <label>Month: <input type="text" id="m-filter-month" placeholder="filter Month"></label>
    <label>Room: <input type="text" id="m-filter-room" placeholder="filter Room"></label>
    <label>User Status: <input type="text" id="m-filter-statususer" placeholder="filter User Status"></label>
    <label>MAT: <input type="text" id="m-filter-mat" placeholder="filter MAT"></label>
    <label>CPH: <input type="text" id="m-filter-cph" placeholder="filter CPH"></label>
    <label>Section: <input type="text" id="m-filter-section" placeholder="filter Section"></label>
    <label>Status AMT: <input type="text" id="m-filter-statusamt" placeholder="filter Status AMT"></label>
    <div class="controls">
        <button class="btn" id="m-clear">Clear filters</button>
    </div>
  </div>
  <table id="m-table" class="small"></table>
</div>

<script>
// ----------------- Helpers -----------------
function formatDateFromSerialOrDate(v){if(v===null||v===undefined||v==='')return"";const o={day:'2-digit',month:'short',year:'numeric'};if(v instanceof Date)return v.toLocaleDateString('en-US',o).replace(/ /g,'-');if(typeof v==='number')return new Date(Math.round((v-25569)*86400*1000)).toLocaleDateString('en-US',o).replace(/ /g,'-');const p=Date.parse(String(v));if(!isNaN(p))return new Date(p).toLocaleDateString('en-US',o).replace(/ /g,'-');return String(v);}
function formatCurrency(v){if(v===null||v===undefined||v==='')return"";const n=Number(String(v).replace(/[^0-9.-]/g,''));return !isNaN(n)?("$"+Math.round(n).toLocaleString()):String(v);}
function applyStyleToTd(td,col,val){if(!td)return;const c=String(col||'').toLowerCase();const v=(val===null||val===undefined)?'':String(val).trim();if(["order","created on","planning","target date","end date","cost","include","exclude"].includes(c))td.style.textAlign="right";else if(["user status","mat"].includes(c))td.style.textAlign="center";else td.style.textAlign="left";if(c==="status part"){if(v==="Complete"){td.style.backgroundColor="green";td.style.color="white";}else if(v==="Not Complete"){td.style.backgroundColor="red";td.style.color="white";}}else if(c==="aging"){const a=parseInt(v);if(!isNaN(a)){td.style.backgroundColor=(a<=30)?"green":"red";td.style.color="white";}}else if(c==="status amt"){if(v==="O"){td.style.backgroundColor="lightgray";td.style.color="black";}else if(v==="YTS"){td.style.backgroundColor="green";td.style.color="white";}else if(v==="IP"){td.style.backgroundColor="orange";td.style.color="red";}else if(v==="C"){td.style.backgroundColor="black";td.style.color="white";}}}
function parseValueForSort(t){const s=(t===null||t===undefined)?'':String(t).trim();if(s==='')return'';const n=Number(s.replace(/[^0-9.\-]/g,''));if(!isNaN(n)&&/[0-9]/.test(s))return n;const p=Date.parse(s);if(!isNaN(p))return p;return s.toLowerCase();}
function clearSortIndicators(t){if(!t)return;t.querySelectorAll('th').forEach(th=>{th.classList.remove('sort-asc','sort-desc');delete th.dataset.sorted;});}
function debounce(fn,wait){let t;return function(...a){clearTimeout(t);t=setTimeout(()=>fn.apply(this,a),wait);};}
function getIndex(headers,keyword){keyword=(keyword||'').toLowerCase();return headers.findIndex(h=>(h||'').toLowerCase().includes(keyword));}

// ----------------- Tab Switch -----------------
const tabs=document.querySelectorAll('.tab');const panels=document.querySelectorAll('.panel');
tabs.forEach(tab=>{tab.addEventListener('click',()=>{tabs.forEach(t=>t.classList.remove('active'));tab.classList.add('active');panels.forEach(p=>p.classList.remove('active'));const pid='panel-'+tab.id.split('-')[1];document.getElementById(pid).classList.add('active');});});

// ----------------- Build Table -----------------
function buildTableFromJson(tableEl,headers,rows){
    while(tableEl.firstChild)tableEl.removeChild(tableEl.firstChild);
    const thead=document.createElement('thead'); const tr=document.createElement('tr');
    headers.forEach((h,i)=>{const th=document.createElement('th'); th.textContent=h; th.dataset.colIndex=i; th.addEventListener('click',()=>sortTableByIndex(tableEl,i,th)); tr.appendChild(th);});
    thead.appendChild(tr); tableEl.appendChild(thead);
    const tbody=document.createElement('tbody'); const frag=document.createDocumentFragment();
    rows.forEach(r=>{const row=document.createElement('tr');for(let i=0;i<headers.length;i++){const col=headers[i]||'';let raw=(r&&r[i]!==undefined&&r[i]!==null)?r[i]:'';let txt='';const lc=col.toLowerCase(); if(["created on","planning","target date","end date"].includes(lc)) txt=formatDateFromSerialOrDate(raw);else if(["cost","include","exclude"].includes(lc)) txt=formatCurrency(raw);else{if(raw instanceof Date) txt=formatDateFromSerialOrDate(raw); else txt=String(raw);} const td=document.createElement('td'); td.textContent=txt; applyStyleToTd(td,col,txt); row.appendChild(td);}frag.appendChild(row);});
    tbody.appendChild(frag); tableEl.appendChild(tbody);
}
function sortTableByIndex(tableEl,colIndex,thElement){if(!tableEl||!tableEl.tBodies[0])return;const tbody=tableEl.tBodies[0];const asc=thElement.dataset.sorted!=='asc';clearSortIndicators(tableEl);thElement.dataset.sorted=asc?'asc':'desc';thElement.classList.add(asc?'sort-asc':'sort-desc');const rows=Array.from(tbody.rows);rows.sort((a,b)=>{const aText=(a.cells[colIndex]&&a.cells[colIndex].textContent)?a.cells[colIndex].textContent:'';const bText=(b.cells[colIndex]&&b.cells[colIndex].textContent)?b.cells[colIndex].textContent:'';const va=parseValueForSort(aText); const vb=parseValueForSort(bText);if(typeof va==='number'&&typeof vb==='number')return asc?(va-vb):(vb-va);if(typeof va==='number')return asc?-1:1;if(typeof vb==='number')return asc?1:-1;return asc?String(va).localeCompare(String(vb)):String(vb).localeCompare(String(va));});rows.forEach(r=>tbody.appendChild(r));}


// ----------------- Menu 1: Work Order -----------------
let wHeaders=[]; const wTable=document.getElementById('w-table');
document.getElementById('w-upload').addEventListener('change',function(e){
    const f=e.target.files[0]; if(!f) return;
    const reader=new FileReader();
    reader.onload=function(ev){
        const data=new Uint8Array(ev.target.result);
        const wb=XLSX.read(data,{type:'array'});
        const sheet=wb.Sheets[wb.SheetNames[0]];
        const json=XLSX.utils.sheet_to_json(sheet,{header:1,raw:true});
        if(!json||json.length===0){alert('No data');return;}
        wHeaders=json[0].map(h=>h===null||h===undefined?'':String(h).trim());
        const rows=json.slice(1); buildTableFromJson(wTable,wHeaders,rows); applyWorkFilters();
    };
    reader.readAsArrayBuffer(f);
});
function applyWorkFilters(){
    const fRoom=(document.getElementById('w-filter-room').value||'').toLowerCase();
    const fOrder=(document.getElementById('w-filter-order').value||'').toLowerCase();
    const fMat=(document.getElementById('w-filter-mat').value||'').toLowerCase();
    const fSection=(document.getElementById('w-filter-section').value||'').toLowerCase();
    const fCph=(document.getElementById('w-filter-cph').value||'').toLowerCase();
    const fStatus=(document.getElementById('w-filter-status').value||'').toLowerCase();
    if(!wTable.tBodies[0]) return; const rows=Array.from(wTable.tBodies[0].rows);
    const idxRoom=getIndex(wHeaders,'room'); const idxOrder=getIndex(wHeaders,'order'); const idxMat=getIndex(wHeaders,'mat'); const idxSection=getIndex(wHeaders,'section'); const idxCph=getIndex(wHeaders,'cph'); const idxStatus=getIndex(wHeaders,'status');
    rows.forEach(row=>{
        let show=true;
        if(fRoom&&idxRoom>=0 && !(row.cells[idxRoom]?.textContent.toLowerCase()||'').includes(fRoom)) show=false;
        if(show&&fOrder&&idxOrder>=0 && !(row.cells[idxOrder]?.textContent.toLowerCase()||'').includes(fOrder)) show=false;
        if(show&&fMat&&idxMat>=0 && !(row.cells[idxMat]?.textContent.toLowerCase()||'').includes(fMat)) show=false;
        if(show&&fSection&&idxSection>=0 && !(row.cells[idxSection]?.textContent.toLowerCase()||'').includes(fSection)) show=false;
        if(show&&fCph&&idxCph>=0 && !(row.cells[idxCph]?.textContent.toLowerCase()||'').includes(fCph)) show=false;
        if(show&&fStatus&&idxStatus>=0 && !(row.cells[idxStatus]?.textContent.toLowerCase()||'').includes(fStatus)) show=false;
        row.style.display=show?'':'none';
    });
}
document.querySelectorAll("#panel-work .filter-container input[type=text]").forEach(inp=>inp.addEventListener('input',debounce(applyWorkFilters,120)));
document.getElementById('w-clear').addEventListener('click',()=>{
    document.querySelectorAll("#panel-work .filter-container input[type=text]").forEach(i=>i.value=''); applyWorkFilters();
});

// ----------------- Menu 2: Detail Part -----------------
let dHeaders=[]; const dTable=document.getElementById('d-table');
document.getElementById('d-upload').addEventListener('change',function(e){
    const f=e.target.files[0]; if(!f) return;
    const reader=new FileReader();
    reader.onload=function(ev){
        const data=new Uint8Array(ev.target.result);
        const wb=XLSX.read(data,{type:'array'});
        const sheet=wb.Sheets[wb.SheetNames[0]];
        const json=XLSX.utils.sheet_to_json(sheet,{header:1,raw:true});
        if(!json||json.length===0){alert('No data');return;}
        dHeaders=json[0].map(h=>h===null||h===undefined?'':String(h).trim());
        const rows=json.slice(1); buildTableFromJson(dTable,dHeaders,rows); applyDetailFilters();
    };
    reader.readAsArrayBuffer(f);
});
function applyDetailFilters(){
    const fOrder=(document.getElementById('d-filter-order').value||'').toLowerCase();
    const fMatNum=(document.getElementById('d-filter-matnum').value||'').toLowerCase();
    const fMatDesc=(document.getElementById('d-filter-matdesc').value||'').toLowerCase();
    if(!dTable.tBodies[0]) return; const rows=Array.from(dTable.tBodies[0].rows);
    const idxOrder=getIndex(dHeaders,'order');
    const idxMatNum=getIndex(dHeaders,'material')!==-1?getIndex(dHeaders,'material'):getIndex(dHeaders,'material number');
    const idxMatDesc=getIndex(dHeaders,'description')!==-1?getIndex(dHeaders,'description'):getIndex(dHeaders,'material description');
    rows.forEach(row=>{
        let show=true;
        if(fOrder){if(idxOrder>=0){const txt=row.cells[idxOrder]?.textContent.toLowerCase()||''; if(!txt.includes(fOrder)) show=false;}else{if(!row.textContent.toLowerCase().includes(fOrder)) show=false;}}
        if(show&&fMatNum){if(idxMatNum>=0){const txt=row.cells[idxMatNum]?.textContent.toLowerCase()||''; if(!txt.includes(fMatNum)) show=false;}else{if(!row.textContent.toLowerCase().includes(fMatNum)) show=false;}}
        if(show&&fMatDesc){if(idxMatDesc>=0){const txt=row.cells[idxMatDesc]?.textContent.toLowerCase()||''; if(!txt.includes(fMatDesc)) show=false;}else{if(!row.textContent.toLowerCase().includes(fMatDesc)) show=false;}}
        row.style.display=show?'':'none';
    });
}
document.querySelectorAll("#panel-detail .filter-container input[type=text]").forEach(inp=>inp.addEventListener('input',debounce(applyDetailFilters,120)));
document.getElementById('d-clear').addEventListener('click',()=>{document.querySelectorAll("#panel-detail .filter-container input[type=text]").forEach(i=>i.value=''); applyDetailFilters();});

// ----------------- Menu 3: External Job -----------------
let eHeaders=[]; const eTable=document.getElementById('e-table');
const allowedCols=["Room","Manufacturer model number","Order Number","Maintenance activity type","Field displaying user status","Description","Aging WO","Net Price in PO USD","Cost Element","Service number","Service Short Text","Name","Purchase Requisition Number","Purchasing Document Number","Entry Sheet Number"];
document.getElementById('e-upload').addEventListener('change',function(e){
    const f=e.target.files[0]; if(!f) return;
    const reader=new FileReader();
    reader.onload=function(ev){
        const data=new Uint8Array(ev.target.result);
        const wb=XLSX.read(data,{type:'array'});
        const sheet=wb.Sheets[wb.SheetNames[0]];
        const json=XLSX.utils.sheet_to_json(sheet,{header:1,raw:true});
        if(!json||json.length===0){alert('No data');return;}
        const rawHeaders=json[0].map(h=>h===null||h===undefined?'':String(h).trim());
        eHeaders=rawHeaders.filter(h=>allowedCols.includes(h));
        const rows=json.slice(1).map(r=>eHeaders.map(h=>{const idx=rawHeaders.indexOf(h); return idx>=0?r[idx]:"";}));
        buildTableFromJson(eTable,eHeaders,rows); applyExtFilters();
    };
    reader.readAsArrayBuffer(f);
});
function applyExtFilters(){
    const fRoom=(document.getElementById('e-filter-room').value||'').toLowerCase();
    const fOrder=(document.getElementById('e-filter-order').value||'').toLowerCase();
    const fAct=(document.getElementById('e-filter-activity').value||'').toLowerCase();
    const fDesc=(document.getElementById('e-filter-desc').value||'').toLowerCase();
    if(!eTable.tBodies[0]) return; const rows=Array.from(eTable.tBodies[0].rows);
    const idxRoom=eHeaders.indexOf("Room"); const idxOrder=eHeaders.indexOf("Order Number"); const idxAct=eHeaders.indexOf("Maintenance activity type"); const idxDesc=eHeaders.indexOf("Description");
    rows.forEach(row=>{
        let show=true;
        if(fRoom&&idxRoom>=0 && !(row.cells[idxRoom]?.textContent.toLowerCase()||'').includes(fRoom)) show=false;
        if(show&&fOrder&&idxOrder>=0 && !(row.cells[idxOrder]?.textContent.toLowerCase()||'').includes(fOrder)) show=false;
        if(show&&fAct&&idxAct>=0 && !(row.cells[idxAct]?.textContent.toLowerCase()||'').includes(fAct)) show=false;
        if(show&&fDesc&&idxDesc>=0 && !(row.cells[idxDesc]?.textContent.toLowerCase()||'').includes(fDesc)) show=false;
        row.style.display=show?'':'none';
    });
}
document.querySelectorAll("#panel-ext .filter-container input[type=text]").forEach(inp=>inp.addEventListener('input',debounce(applyExtFilters,120)));
document.getElementById('e-clear').addEventListener('click',()=>{document.querySelectorAll("#panel-ext .filter-container input[type=text]").forEach(i=>i.value=''); applyExtFilters();});

<!-- ----------------- Menu 4: List WO Monthly ----------------- -->
(function(){
    const mTable=document.getElementById('m-table');
    function buildMonthlyTable(){
        if(!wTable||!wTable.tBodies[0]||!wHeaders)return;
        const fMonth=(document.getElementById('m-filter-month').value||'').toLowerCase();
        const fRoom=(document.getElementById('m-filter-room').value||'').toLowerCase();
        const fUserStatus=(document.getElementById('m-filter-statususer').value||'').toLowerCase();
        const fMat=(document.getElementById('m-filter-mat').value||'').toLowerCase();
        const fCph=(document.getElementById('m-filter-cph').value||'').toLowerCase();
        const fSection=(document.getElementById('m-filter-section').value||'').toLowerCase();
        const fStatusAmt=(document.getElementById('m-filter-statusamt').value||'').toLowerCase();
        const headers=wHeaders.slice();
        const rows=Array.from(wTable.tBodies[0].rows)
            .filter(r=>{
                let show=true;
                const idxMonth=getIndex(headers,'month'); 
                const idxRoom=getIndex(headers,'room');
                const idxUserStatus=getIndex(headers,'user status'); 
                const idxMat=getIndex(headers,'mat');
                const idxCph=getIndex(headers,'cph'); 
                const idxSection=getIndex(headers,'section');
                const idxStatusAmt=getIndex(headers,'status amt');
                if(idxMonth>=0 && fMonth && !(r.cells[idxMonth]?.textContent.toLowerCase()||'').includes(fMonth))show=false;
                if(idxRoom>=0 && fRoom && !(r.cells[idxRoom]?.textContent.toLowerCase()||'').includes(fRoom))show=false;
                if(idxUserStatus>=0 && fUserStatus && !(r.cells[idxUserStatus]?.textContent.toLowerCase()||'').includes(fUserStatus))show=false;
                if(idxMat>=0 && fMat && !(r.cells[idxMat]?.textContent.toLowerCase()||'').includes(fMat))show=false;
                if(idxCph>=0 && fCph && !(r.cells[idxCph]?.textContent.toLowerCase()||'').includes(fCph))show=false;
                if(idxSection>=0 && fSection && !(r.cells[idxSection]?.textContent.toLowerCase()||'').includes(fSection))show=false;
                if(idxStatusAmt>=0 && fStatusAmt && !(r.cells[idxStatusAmt]?.textContent.toLowerCase()||'').includes(fStatusAmt))show=false;
                return show;
            })
            .map(r=>Array.from(r.cells).map(c=>c.textContent));
        buildTableFromJson(mTable,headers,rows);
    }
    document.querySelectorAll("#panel-monthly .filter-container input[type=text]")
        .forEach(inp=>inp.addEventListener('input',debounce(buildMonthlyTable,120)));
    document.getElementById('m-clear').addEventListener('click',()=>{
        document.querySelectorAll("#panel-monthly .filter-container input[type=text]").forEach(i=>i.value='');
        buildMonthlyTable();
    });
})();
</script>

<!-- ----------------- PANEL 5: Add WO Monthly ----------------- -->
<div class="panel" id="panel-addmonthly">
  <h3>Add WO Monthly</h3>
  <div class="filter-container">
    <label>Order: <input type="text" id="a-order" placeholder="Order"></label>
    <button class="btn" id="a-add">Add</button>
  </div>
  <table id="a-table" class="small"></table>
  <div class="filter-container">
    <label>Filter Room: <input type="text" id="a-filter-room"></label>
    <label>Filter Order: <input type="text" id="a-filter-order"></label>
    <button class="btn" id="a-clear">Clear filters</button>
    <button class="btn" id="a-save">Save JSON</button>
    <input type="file" id="a-load" accept=".json" />
  </div>
</div>

<script>
// ----------------- Menu 5: Add WO Monthly -----------------
let aHeaders=["Room","Order","Description","MAT","Month","Reman","Action"];
let aData=[]; 
const aTable=document.getElementById("a-table");

function buildAddMonthlyTable(){
    aTable.innerHTML="";
    const thead=document.createElement("thead");
    const trh=document.createElement("tr");
    aHeaders.forEach(h=>{
        const th=document.createElement("th");
        th.textContent=h;
        trh.appendChild(th);
    });
    thead.appendChild(trh);
    aTable.appendChild(thead);

    const tbody=document.createElement("tbody");
    aData.forEach((row,idx)=>{
        const tr=document.createElement("tr");
        row.forEach((val,colIdx)=>{
            const td=document.createElement("td");
            if(aHeaders[colIdx]==="Month" || aHeaders[colIdx]==="Reman"){
                const inp=document.createElement("input");
                inp.type="text";
                inp.value=val||"";
                inp.disabled=!row.editing;
                inp.addEventListener("input",e=>{
                    aData[idx][colIdx]=e.target.value;
                });
                td.appendChild(inp);
            } else {
                td.textContent=val;
            }
            tr.appendChild(td);
        });
        // action buttons
        const tdAct=document.createElement("td");
        if(row.editing){
            const btnSave=document.createElement("button");
            btnSave.textContent="Save";
            btnSave.className="btn";
            btnSave.onclick=()=>{row.editing=false;buildAddMonthlyTable();};
            tdAct.appendChild(btnSave);
        }else{
            const btnEdit=document.createElement("button");
            btnEdit.textContent="Edit";
            btnEdit.className="btn";
            btnEdit.onclick=()=>{row.editing=true;buildAddMonthlyTable();};
            tdAct.appendChild(btnEdit);
        }
        const btnDel=document.createElement("button");
        btnDel.textContent="Delete";
        btnDel.className="btn";
        btnDel.onclick=()=>{aData.splice(idx,1);buildAddMonthlyTable();};
        tdAct.appendChild(btnDel);
        tr.appendChild(tdAct);
        tbody.appendChild(tr);
    });
    aTable.appendChild(tbody);
    applyAddMonthlyFilters();
}

// Ambil data dari Menu 1 berdasarkan Order
function findWorkOrder(order){
    if(!wTable.tBodies[0]) return null;
    const rows=Array.from(wTable.tBodies[0].rows);
    const idxOrder=getIndex(wHeaders,"order");
    const idxRoom=getIndex(wHeaders,"room");
    const idxDesc=getIndex(wHeaders,"description");
    const idxMat=getIndex(wHeaders,"mat");
    for(const r of rows){
        if(idxOrder>=0 && r.cells[idxOrder].textContent.trim()===order){
            return {
                room: idxRoom>=0?r.cells[idxRoom].textContent:"",
                desc: idxDesc>=0?r.cells[idxDesc].textContent:"",
                mat: idxMat>=0?r.cells[idxMat].textContent:""
            };
        }
    }
    return null;
}

// Tambah Order
document.getElementById("a-add").addEventListener("click",()=>{
    const order=document.getElementById("a-order").value.trim();
    if(!order){alert("Order wajib diisi!");return;}
    const base=findWorkOrder(order);
    if(!base){alert("Order tidak ditemukan di Work Order!");return;}
    aData.push([base.room,order,base.desc,base.mat,"","",{editing:false}]);
    buildAddMonthlyTable();
});

// Filter
function applyAddMonthlyFilters(){
    const fRoom=(document.getElementById("a-filter-room").value||"").toLowerCase();
    const fOrder=(document.getElementById("a-filter-order").value||"").toLowerCase();
    if(!aTable.tBodies[0]) return;
    const rows=Array.from(aTable.tBodies[0].rows);
    const idxRoom=aHeaders.indexOf("Room");
    const idxOrder=aHeaders.indexOf("Order");
    rows.forEach(r=>{
        let show=true;
        if(fRoom && !(r.cells[idxRoom]?.textContent.toLowerCase()||"").includes(fRoom)) show=false;
        if(show && fOrder && !(r.cells[idxOrder]?.textContent.toLowerCase()||"").includes(fOrder)) show=false;
        r.style.display=show?"":"none";
    });
}
document.querySelectorAll("#panel-addmonthly .filter-container input[type=text]")
    .forEach(inp=>inp.addEventListener("input",debounce(applyAddMonthlyFilters,120)));

document.getElementById("a-clear").addEventListener("click",()=>{
    document.querySelectorAll("#panel-addmonthly .filter-container input[type=text]").forEach(i=>i.value="");
    applyAddMonthlyFilters();
});

// Save JSON
document.getElementById("a-save").addEventListener("click",()=>{
    const dataToSave=aData.map(r=>r.slice(0,6)); // tanpa field editing
    const blob=new Blob([JSON.stringify(dataToSave)],{type:"application/json"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url;a.download="wo_monthly.json";a.click();
    URL.revokeObjectURL(url);
});

// Load JSON
document.getElementById("a-load").addEventListener("change",function(e){
    const f=e.target.files[0]; if(!f) return;
    const reader=new FileReader();
    reader.onload=function(ev){
        try{
            const arr=JSON.parse(ev.target.result);
            aData=arr.map(r=>[...r,{editing:false}]);
        }catch(err){alert("Invalid JSON");return;}
        buildAddMonthlyTable();
    };
    reader.readAsText(f);
});
</script>
</body>
</html>
