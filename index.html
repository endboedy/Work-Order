<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Work Order EM</title>
  <style>
    body { font-family: Arial, sans-serif; }
    .panel { display:none; margin-top:20px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 5px; text-align: center; }
    .filter-container { margin-bottom: 10px; }
  </style>
</head>
<body>
  <h1>Work Order EM</h1>

  <!-- Menu Buttons -->
  <button onclick="showMenu('panel-pm')">Menu 1 - Planning PM</button>
  <button onclick="showMenu('panel-smu')">Menu 2 - Current SMU</button>
  <button onclick="showMenu('panel-ext')">Menu 3 - External Job</button>

  <!-- ================= MENU 1 ================= -->
  <div id="panel-pm" class="panel">
    <h2>Menu 1 - Planning PM</h2>
    <input type="file" id="pm-upload" accept=".xlsx,.xls" />
    <table id="pm-table"></table>
  </div>

  <!-- ================= MENU 2 ================= -->
  <div id="panel-smu" class="panel">
    <h2>Menu 2 - Current SMU</h2>
    <input type="file" id="smu-upload" accept=".xlsx,.xls" />
    <table id="smu-table"></table>
  </div>

  <!-- ================= MENU 3 ================= -->
  <div id="panel-ext" class="panel">
    <h2>Menu 3 - External Job</h2>
    <input type="file" id="e-upload" accept=".xlsx,.xls" />

    <div class="filter-container">
      <input type="text" id="e-filter-room" placeholder="Filter Room">
      <input type="text" id="e-filter-order" placeholder="Filter Order Number">
      <input type="text" id="e-filter-activity" placeholder="Filter Activity Type">
      <input type="text" id="e-filter-desc" placeholder="Filter Description">
      <input type="text" id="e-filter-pr" placeholder="Filter Purchase Requisition Number">
      <input type="text" id="e-filter-pd" placeholder="Filter Purchase Document Number">
      <button id="e-clear">Clear</button>
    </div>

    <table id="e-table"></table>
  </div>

  <!-- ================= SCRIPT ================= -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    function showMenu(id) {
      document.querySelectorAll('.panel').forEach(p => p.style.display = 'none');
      document.getElementById(id).style.display = 'block';
    }

    function buildTableFromJson(table, headers, rows) {
      table.innerHTML = '';
      const thead = table.createTHead();
      const tr = thead.insertRow();
      headers.forEach(h => {
        const th = document.createElement('th');
        th.textContent = h;
        tr.appendChild(th);
      });
      const tbody = table.createTBody();
      rows.forEach(r => {
        const row = tbody.insertRow();
        headers.forEach((_, i) => {
          const cell = row.insertCell();
          cell.textContent = r[i] !== undefined ? r[i] : '';
        });
      });
    }

    function getIndex(headers, name) {
      const n = name.toLowerCase();
      return headers.findIndex(h => h.toLowerCase().includes(n));
    }

    function debounce(fn, delay) {
      let t; 
      return function(...args) {
        clearTimeout(t);
        t = setTimeout(() => fn.apply(this, args), delay);
      }
    }

    /*********************
     * Menu 1
     *********************/
    document.getElementById('pm-upload').addEventListener('change', function(e){
      const f = e.target.files[0]; if (!f) return;
      const reader = new FileReader();
      reader.onload = function(ev){
        const wb = XLSX.read(new Uint8Array(ev.target.result), {type:'array'});
        const sheet = wb.Sheets[wb.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet, {header:1});
        buildTableFromJson(document.getElementById('pm-table'), json[0], json.slice(1));
      };
      reader.readAsArrayBuffer(f);
    });

    /*********************
     * Menu 2
     *********************/
    document.getElementById('smu-upload').addEventListener('change', function(e){
      const f = e.target.files[0]; if (!f) return;
      const reader = new FileReader();
      reader.onload = function(ev){
        const wb = XLSX.read(new Uint8Array(ev.target.result), {type:'array'});
        const sheet = wb.Sheets[wb.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet, {header:1});
        buildTableFromJson(document.getElementById('smu-table'), json[0], json.slice(1));
      };
      reader.readAsArrayBuffer(f);
    });

    /*********************
     * Menu 3
     *********************/
    let eHeaders = [];
    const eTable = document.getElementById('e-table');

    document.getElementById('e-upload').addEventListener('change', function(e){
      const f = e.target.files[0]; if (!f) return;
      const reader = new FileReader();
      reader.onload = function(ev) {
        const wb = XLSX.read(new Uint8Array(ev.target.result), {type:'array'});
        const sheet = wb.Sheets[wb.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet, {header:1});
        eHeaders = json[0];
        const rows = json.slice(1);

        // filter hanya kolom yang diinginkan
        const wanted = [
          "Room","Manufacturer model number","Order Number","Maintenance activity type",
          "Field displaying user status","Description","Aging WO","Net Price in PO USD",
          "Cost Element","Service number","Service Short Text","Name",
          "Purchase Requisition Number","Purchasing Document Number","Entry Sheet Number"
        ];
        const idxs = wanted.map(w => getIndex(eHeaders, w));
        const newHeaders = wanted;
        const newRows = rows.map(r => idxs.map(i => r[i]));
        
        buildTableFromJson(eTable, newHeaders, newRows);
        applyExtFilters();
      };
      reader.readAsArrayBuffer(f);
    });

    function applyExtFilters() {
      const fRoom = (document.getElementById('e-filter-room').value || '').toLowerCase();
      const fOrder = (document.getElementById('e-filter-order').value || '').toLowerCase();
      const fAct = (document.getElementById('e-filter-activity').value || '').toLowerCase();
      const fDesc = (document.getElementById('e-filter-desc').value || '').toLowerCase();
      const fPR = (document.getElementById('e-filter-pr').value || '').toLowerCase();
      const fPD = (document.getElementById('e-filter-pd').value || '').toLowerCase();
      if (!eTable.tBodies[0]) return;
      const rows = Array.from(eTable.tBodies[0].rows);

      const idxRoom = getIndex(eHeaders, 'room');
      const idxOrder = getIndex(eHeaders, 'order number');
      const idxAct = getIndex(eHeaders, 'maintenance activity type');
      const idxDesc = getIndex(eHeaders, 'description');
      const idxPR = getIndex(eHeaders, 'purchase requisition number');
      const idxPD = getIndex(eHeaders, 'purchasing document number');

      rows.forEach(row => {
        let show = true;
        if (fRoom && idxRoom >= 0 && !row.cells[idxRoom].textContent.toLowerCase().includes(fRoom)) show = false;
        if (show && fOrder && idxOrder >= 0 && !row.cells[idxOrder].textContent.toLowerCase().includes(fOrder)) show = false;
        if (show && fAct && idxAct >= 0 && !row.cells[idxAct].textContent.toLowerCase().includes(fAct)) show = false;
        if (show && fDesc && idxDesc >= 0 && !row.cells[idxDesc].textContent.toLowerCase().includes(fDesc)) show = false;
        if (show && fPR && idxPR >= 0 && !row.cells[idxPR].textContent.toLowerCase().includes(fPR)) show = false;
        if (show && fPD && idxPD >= 0 && !row.cells[idxPD].textContent.toLowerCase().includes(fPD)) show = false;
        row.style.display = show ? '' : 'none';
      });
    }

    const debouncedApplyExtFilters = debounce(applyExtFilters, 120);
    document.querySelectorAll("#panel-ext .filter-container input[type=text]").forEach(inp => 
      inp.addEventListener('input', debouncedApplyExtFilters));
    document.getElementById('e-clear').addEventListener('click', () => {
      document.querySelectorAll("#panel-ext .filter-container input[type=text]").forEach(i => i.value = '');
      applyExtFilters();
    });
  </script>
</body>
</html>
