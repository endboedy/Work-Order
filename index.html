<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>WORK_ORDER_EM</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: Arial; font-size: 12px; margin: 12px; }
        .filter-container { margin-bottom: 12px; padding: 10px; background-color: #f7f7f7; border-radius: 6px; }
        .filter-container label { margin-right: 8px; font-size: 13px; }
        table { border-collapse: collapse; width: 100%; margin-top: 8px; }
        th, td { border: 1px solid #ccc; padding: 6px; }
        th { background-color: #eee; cursor: pointer; user-select: none; }
        th.sort-asc::after { content: " ▲"; font-size: 10px; color: #333; }
        th.sort-desc::after { content: " ▼"; font-size: 10px; color: #333; }
    </style>
</head>
<body>
    <h2>WORK_ORDER_EM</h2>
    <div class="filter-container">
        <label>Room: <input type="text" id="filter-room" placeholder="filter Room"></label>
        <label>Order: <input type="text" id="filter-order" placeholder="filter Order"></label>
        <label>MAT: <input type="text" id="filter-mat" placeholder="filter MAT"></label>
        <label>Section: <input type="text" id="filter-section" placeholder="filter Section"></label>
        <label>CPH: <input type="text" id="filter-cph" placeholder="filter CPH"></label>
        <label>Status: <input type="text" id="filter-status" placeholder="filter Status"></label>
        <br><br>
        <input type="file" id="upload" accept=".xlsx" />
        <button id="clear-filters" style="margin-left:12px;">Clear filters</button>
    </div>

    <table id="wo-table"></table>

    <script>
        // --- helper ---
        function escapeHtml(str) {
            if (str === null || str === undefined) return '';
            return String(str)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;");
        }

        function formatDateFromSerialOrDate(v) {
            if (!v) return "";
            const options = { day: '2-digit', month: 'short', year: 'numeric' };
            if (v instanceof Date) return v.toLocaleDateString('en-US', options).replace(/ /g, '-');
            if (typeof v === 'number') {
                const date = new Date(Math.round((v - 25569) * 86400 * 1000));
                return date.toLocaleDateString('en-US', options).replace(/ /g, '-');
            }
            const parsed = Date.parse(v);
            if (!isNaN(parsed)) return new Date(parsed).toLocaleDateString('en-US', options).replace(/ /g, '-');
            return String(v);
        }

        function formatCurrency(value) {
            if (!value) return "";
            const num = Number(String(value).replace(/[^0-9.-]/g, ''));
            return isNaN(num) ? value : "$" + Math.round(num).toLocaleString();
        }

        function applyStyle(col, val) {
            let style = "", align = "left";
            if (["Order", "Created On", "Planning", "Target Date", "End Date", "Cost", "Include", "Exclude"].includes(col)) align = "right";
            else if (["User Status", "MAT"].includes(col)) align = "center";

            if (col === "Status Part") {
                if (val === "Complete") style = "background-color:green;color:white;";
                else if (val === "Not Complete") style = "background-color:red;color:white;";
            } else if (col === "Aging") {
                const aging = parseInt(val);
                if (!isNaN(aging)) style = (aging <= 30) ? "background-color:green;color:white;" : "background-color:red;color:white;";
            } else if (col === "Status AMT") {
                if (val === "O") style = "background-color:lightgray;color:black;";
                else if (val === "YTS") style = "background-color:green;color:white;";
                else if (val === "IP") style = "background-color:orange;color:red;";
                else if (val === "C") style = "background-color:black;color:white;";
            }
            return style="text-align:${align};${style}";
        }

        // --- sorting ---
        function clearSortIndicators(thead) {
            thead.querySelectorAll('th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                delete th.dataset.sorted;
            });
        }

        function parseValueForSort(text) {
            if (!text) return '';
            const s = text.trim();
            const num = Number(s.replace(/[^0-9.\-]/g, ''));
            if (!isNaN(num) && /[0-9]/.test(s)) return num;
            const parsed = Date.parse(s);
            if (!isNaN(parsed)) return parsed;
            return s.toLowerCase();
        }

        function sortTable(header) {
            const table = header.closest("table");
            const tbody = table.querySelector("tbody");
            const ths = Array.from(table.querySelectorAll("th"));
            const index = ths.indexOf(header);
            const asc = header.dataset.sorted !== 'asc';
            clearSortIndicators(table.querySelector('thead'));
            header.dataset.sorted = asc ? 'asc' : 'desc';
            header.classList.add(asc ? 'sort-asc' : 'sort-desc');

            const rows = Array.from(tbody.rows);
            rows.sort((a, b) => {
                const va = parseValueForSort(a.cells[index].innerText);
                const vb = parseValueForSort(b.cells[index].innerText);
                if (typeof va === 'number' && typeof vb === 'number') return asc ? va - vb : vb - va;
                return asc ? String(va).localeCompare(String(vb)) : String(vb).localeCompare(String(va));
            });
            rows.forEach(r => tbody.appendChild(r));
        }
        window.sortTable = sortTable;

        // --- filtering (optimized) ---
        let currentHeaders = [];
        function getIndexByKeyword(keyword) {
            keyword = keyword.toLowerCase();
            return currentHeaders.findIndex(h => h.toLowerCase().includes(keyword));
        }

        function filterTable() {
            const fRoom = document.getElementById("filter-room").value.toLowerCase();
            const fOrder = document.getElementById("filter-order").value.toLowerCase();
            const fMat = document.getElementById("filter-mat").value.toLowerCase();
            const fSection = document.getElementById("filter-section").value.toLowerCase();
            const fCph = document.getElementById("filter-cph").value.toLowerCase();
            const fStatus = document.getElementById("filter-status").value.toLowerCase();

            const tbody = document.querySelector("#wo-table tbody");
            if (!tbody) return;

            const idxRoom = getIndexByKeyword('room');
            const idxOrder = getIndexByKeyword('order');
            const idxMat = getIndexByKeyword('mat');
            const idxSection = getIndexByKeyword('section');
            const idxCph = getIndexByKeyword('cph');
            const idxStatus = getIndexByKeyword('status');

            Array.from(tbody.rows).forEach(row => {
                let show = true;
                if (fRoom && idxRoom >= 0 && !row.cells[idxRoom].innerText.toLowerCase().includes(fRoom)) show = false;
                if (show && fOrder && idxOrder >= 0 && !row.cells[idxOrder].innerText.toLowerCase().includes(fOrder)) show = false;
                if (show && fMat && idxMat >= 0 && !row.cells[idxMat].innerText.toLowerCase().includes(fMat)) show = false;
                if (show && fSection && idxSection >= 0 && !row.cells[idxSection].innerText.toLowerCase().includes(fSection)) show = false;
                if (show && fCph && idxCph >= 0 && !row.cells[idxCph].innerText.toLowerCase().includes(fCph)) show = false;
                if (show && fStatus && idxStatus >= 0 && !row.cells[idxStatus].innerText.toLowerCase().includes(fStatus)) show = false;
                row.style.display = show ? "" : "none";
            });
        }

        document.querySelectorAll(".filter-container input[type=text]").forEach(inp => {
            inp.addEventListener('input', filterTable);
        });
        document.getElementById('clear-filters').addEventListener('click', () => {
            document.querySelectorAll(".filter-container input[type=text]").forEach(inp => inp.value = '');
            filterTable();
        });

        // --- upload & render ---
        document.getElementById('upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(ev) {
                const data = new Uint8Array(ev.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(sheet, { header:1, raw:true });
                if (!json.length) return;

                currentHeaders = json[0].map(h => h ? String(h).trim() : "");
                const rows = json.slice(1);

                let html = "<thead><tr>";
                currentHeaders.forEach(h => html += <th onclick="sortTable(this)">${escapeHtml(h)}</th>);
                html += "</tr></thead><tbody>";

                rows.forEach(r => {
                    html += "<tr>";
                    currentHeaders.forEach((col,i) => {
                        let val = r[i] || "";
                        if (["Created On","Planning","Target Date","End Date"].includes(col)) val = formatDateFromSerialOrDate(val);
                        else if (["Cost","Include","Exclude"].includes(col)) val = formatCurrency(val);
                        else val = escapeHtml(String(val));
                        const style = applyStyle(col,val);
                        html += <td ${style}>${val}</td>;
                    });
                    html += "</tr>";
                });
                html += "</tbody>";

                document.getElementById("wo-table").innerHTML = html;
                filterTable();
            };
            reader.readAsArrayBuffer(file);
        });
    </script>
</body>
</html>
